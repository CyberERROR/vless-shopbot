{% extends "base.html" %} {% block title %}–ê–¥–º–∏–Ω ‚Äî –ö–ª—é—á–∏{% endblock %}
{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">–ö–ª—é—á–∏</h2>
      <div class="text-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
    </div>
  </div>
</div>

<div class="card glass mb-3">
  <div class="card-body">
    <!-- Mode Switcher -->
    <div class="mb-3">
      <div class="btn-group w-100" role="group">
        <input type="radio" class="btn-check" name="mode_switch" id="mode_personal" value="personal" checked autocomplete="off">
        <label class="btn btn-outline-primary" for="mode_personal">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (Personal)</label>

        <input type="radio" class="btn-check" name="mode_switch" id="mode_gift" value="gift" autocomplete="off">
        <label class="btn btn-outline-success" for="mode_gift">üéÅ –ü–æ–¥–∞—Ä–æ—á–Ω—ã–π (Gift Key)</label>
      </div>
    </div>

    <form action="{{ url_for('create_key_ajax_route') }}" method="post" class="row g-2 align-items-end" id="create-key-form" autocomplete="off">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="mode" id="form_mode" value="personal" />

      <!-- User field (Only for Personal) -->
      <div class="col-12 col-sm-3" id="field-user-container">
        <label class="form-label" for="user_id">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
        <div class="input-group">
          <input class="form-control rounded-3" id="user_id" name="user_id" placeholder="ID –∏–ª–∏ @username" required />
        </div>
      </div>

      <div class="col-12 col-sm-3">
        <label class="form-label" for="host_name">–•–æ—Å—Ç</label>
        <div class="soft-select" id="host_softselect" data-target="host_name">
          <button type="button" class="soft-select-toggle" id="host_name_toggle">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç...</button>
          <div class="soft-select-menu" id="host_name_menu"></div>
          <select class="form-select rounded-3 select-soft" id="host_name" name="host_name" required>
            <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç...</option>
            {% for h in hosts %}
            <option value="{{ h.host_name }}" data-inbound="{{ h.inbound }}">{{ h.host_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-12 col-sm-2">
        <label class="form-label" for="inbound_id">Inbound ID</label>
        <input class="form-control rounded-3" type="text" id="inbound_id" placeholder="‚Äî" readonly />
      </div>
      <div class="col-12 col-sm-4" id="field-email-container">
        <label class="form-label" for="key_email">Email –∫–ª—é—á–∞</label>
        <input class="form-control rounded-3" type="email" id="key_email" name="key_email" placeholder="user@bot.local" required readonly />
      </div>
      <div class="col-12 col-sm-4">
        <label class="form-label" for="plan_select">–¢–∞—Ä–∏—Ñ</label>
        <div class="input-group">
          <div class="soft-select flex-grow-1" id="plan_softselect" data-target="plan_select">
            <button type="button" class="soft-select-toggle" id="plan_select_toggle">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</button>
            <div class="soft-select-menu" id="plan_select_menu"></div>
            <select class="form-select rounded-3 select-soft" id="plan_select">
              <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>
            </select>
          </div>
          <span class="input-group-text rounded-3 fw-semibold text-white bg-purple" id="plan_price" style="border:0;">‚Äî RUB</span>
        </div>
      </div>
      <div class="col-12 col-sm-2">
        <label class="form-label" for="custom_days">–î–Ω–µ–π</label>
        <input class="form-control rounded-3" type="number" id="custom_days" min="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 30" />
      </div>
      <div class="col-12 col-sm-4">
        <label class="form-label" for="expiry_date">–ò—Å—Ç–µ–∫–∞–µ—Ç</label>
        <div class="d-flex flex-wrap align-items-stretch gap-2 gp-presets">
          <input class="form-control rounded-3 expiry-input" type="text" id="expiry_date" name="expiry_date" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É" />
          <button class="btn btn-outline-secondary rounded-3" type="button" data-preset="30">+30</button>
          <button class="btn btn-outline-secondary rounded-3" type="button" data-preset="90">+90</button>
          <button class="btn btn-outline-secondary rounded-3" type="button" data-preset="180">+180</button>
          <button class="btn btn-outline-secondary rounded-3" type="button" data-preset="365">+365</button>
        </div>
      </div>
      <div class="col-12 col-sm-12">
        <button type="button" class="btn btn-primary rounded-3" id="btn-submit-create">–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-vcenter">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>–•–æ—Å—Ç</th>
            <th>Email</th>
            <th>UUID</th>
            <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
            <th>–°–æ–∑–¥–∞–Ω</th>
            <th class="w-1">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="keys-tbody" data-fetch-url="{{ url_for('admin_keys_table_partial') }}" data-fetch-interval="10000">
          {% for k in keys %}
          <tr>
            <td>#{{ k.key_id }}</td>
            <td>{{ k.user_id }}</td>
            <td>{{ k.host_name }}</td>
            <td>{{ k.key_email }}</td>
            <td class="text-truncate" style="max-width:180px">{{ k.xui_client_uuid }}</td>
            <td>{{ k.expiry_date or '' }}</td>
            <td>{{ k.created_date or '' }}</td>
            <td>
              <div class="btn-list">
                <form action="{{ url_for('delete_key_route', key_id=k.key_id) }}" method="post" data-confirm="–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á #{{ k.key_id }}?">
                  <button type="submit" class="btn btn-danger btn-sm">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="8">
              <form class="row g-2 align-items-center" action="{{ url_for('update_key_comment_route', key_id=k.key_id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="col-12 col-md-10">
                  <input class="form-control rounded-pill" type="text" name="comment" value="{{ k.comment or '' }}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
                </div>
                <div class="col-12 col-md-2">
                  <button class="btn btn-outline-secondary rounded-pill w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                </div>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- —É–¥–∞–ª—ë–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è —Å–∫—Ä–∏–ø—Ç, –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∏–∂–µ –≤ –æ–±—â–∏–π IIFE -->

<!-- Toasts –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ AJAX -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
  <div id="toastOk" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">–ö–ª—é—á –≤—ã–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
  <div id="toastErr" class="toast align-items-center text-bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –∫–ª—é—á–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å XUI.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
  (function(){
    // --- Mode Switching Logic ---
    const modeInputs = document.querySelectorAll('input[name="mode_switch"]');
    const formModeInput = document.getElementById('form_mode');
    const userContainer = document.getElementById('field-user-container');
    const emailContainer = document.getElementById('field-email-container');
    const userField = document.getElementById('user_id');
    const emailField = document.getElementById('key_email');

    function updateMode() {
      const mode = document.querySelector('input[name="mode_switch"]:checked').value;
      if (formModeInput) formModeInput.value = mode;

      if (mode === 'gift') {
        // Hide User field, disable requirement
        if (userContainer) userContainer.style.display = 'none';
        if (userField) userField.required = false;
        
        // Hide Email field (auto-generated by backend)
        if (emailContainer) emailContainer.style.display = 'none';
        if (emailField) emailField.required = false;
      } else {
        // Show User field
        if (userContainer) userContainer.style.display = 'block';
        if (userField) userField.required = true;

        // Show Email field
        if (emailContainer) emailContainer.style.display = 'block';
        if (emailField) emailField.required = true;
      }
    }

    modeInputs.forEach(inp => inp.addEventListener('change', updateMode));
    // Initial call
    updateMode();

    // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -> –ø–æ—Å—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É @username -> telegram_id –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    const USERS = JSON.parse(String.raw`{{ users | tojson | safe }}`);
    const USER_MAP = {};
    try {
      (USERS || []).forEach(u => {
        if (u && u.username) {
          USER_MAP['@' + String(u.username).toLowerCase()] = u.telegram_id;
        }
      });
    } catch(_) {}

    const form = document.getElementById('create-key-form');
    const submitBtn = document.getElementById('btn-submit-create');
    if (!form || !submitBtn) return;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º Enter, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ —Å–∞–±–º–∏—Ç–∏–ª —Ñ–æ—Ä–º—É –Ω–∞—Ç–∏–≤–Ω–æ
    form.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ localStorage
    const fields = ['user_id','host_name','key_email','plan_select','custom_days','expiry_date'];
    function saveState(){
      const state = {};
      fields.forEach(id => { const el = document.getElementById(id); if (el) state[id] = el.value; });
      try { localStorage.setItem('admin_keys_form', JSON.stringify(state)); } catch(_){ }
    }
    function restoreState(){
      try {
        const raw = localStorage.getItem('admin_keys_form');
        if (!raw) return;
        const st = JSON.parse(raw);
        fields.forEach(id => { const el = document.getElementById(id); if (el && st[id] != null) el.value = st[id]; });
      } catch(_){ }
    }
    restoreState();
    form.addEventListener('input', saveState);
    form.addEventListener('change', saveState);

    // –ü—Ä–µ—Ñ–∏–ª –∏–∑ query ?user_id=
    try {
      const params = new URLSearchParams(location.search);
      const uid = params.get('user_id');
      if (uid) {
        const el = document.getElementById('user_id');
        if (el) el.value = uid;
      }
    } catch(_) {}

    // –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ö–æ—Å—Ç, —Å—Ä–∞–∑—É –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å inbound –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã
    const hostSel = document.getElementById('host_name');
    const inboundEl = document.getElementById('inbound_id');
    const planSel = document.getElementById('plan_select');
    const priceEl = document.getElementById('plan_price');
    const expiryInput = document.getElementById('expiry_date');
    const daysInput = document.getElementById('custom_days');
    const emailInput = document.getElementById('key_email');
    const userInput = document.getElementById('user_id');

    // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å data-fetch-url (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    async function refreshContainerById(id){
      try{
        const el = document.getElementById(id);
        if (!el) return;
        const url = el.getAttribute('data-fetch-url');
        if (!url) return;
        const resp = await fetch(url, { headers: { 'Accept': 'text/html' }, cache: 'no-store', credentials: 'same-origin' });
        if (!resp.ok) return;
        const html = await resp.text();
        if (html && html !== el.innerHTML) { el.innerHTML = html; }
      }catch(_){ }
    }

    // ---- Soft Select helpers ----
    function buildSoftSelect(selectEl, toggleEl, menuEl, placeholder){
      if (!selectEl || !toggleEl || !menuEl) return;
      // Render items
      menuEl.innerHTML = '';
      const opts = Array.from(selectEl.options || []);
      opts.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'soft-select-item' + (opt.selected ? ' is-active' : '');
        div.dataset.value = opt.value;
        div.textContent = opt.textContent || '';
        div.addEventListener('click', () => {
          selectEl.value = opt.value;
          // Update active visuals
          menuEl.querySelectorAll('.soft-select-item').forEach(el => el.classList.remove('is-active'));
          div.classList.add('is-active');
          // Update toggle text
          toggleEl.textContent = opt.textContent || placeholder || '';
          // Close
          toggleEl.closest('.soft-select')?.classList.remove('open');
          // Fire native change for existing logic
          selectEl.dispatchEvent(new Event('change', { bubbles: true }));
          // –ï—Å–ª–∏ —ç—Ç–æ —Ö–æ—Å—Ç ‚Äî —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏–º inbound
          if (selectEl.id === 'host_name') { try { updateInbound(); } catch(_){} }
        });
        menuEl.appendChild(div);
      });
      // Set initial toggle text
      const selOpt = opts.find(o => o.selected) || opts[0];
      toggleEl.textContent = (selOpt && selOpt.textContent) || placeholder || '';
      // Toggle open/close (–º–µ–Ω—é –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ body –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)
      const wrap = toggleEl.closest('.soft-select');
      function placeMenu() {
        const r = toggleEl.getBoundingClientRect();
        menuEl.style.position = 'fixed';
        menuEl.style.left = `${Math.round(r.left)}px`;
        menuEl.style.top = `${Math.round(r.bottom + 6)}px`;
        menuEl.style.width = `${Math.round(r.width)}px`;
        menuEl.style.zIndex = '1065';
      }
      function openMenu(){
        if (menuEl.parentElement !== document.body) {
          document.body.appendChild(menuEl);
        }
        placeMenu();
        wrap.classList.add('open');
        menuEl.style.display = 'block';
        window.addEventListener('scroll', placeMenu, true);
        window.addEventListener('resize', placeMenu, true);
      }
      function closeMenu(){
        wrap.classList.remove('open');
        menuEl.style.display = 'none';
        // –í–µ—Ä–Ω—ë–º –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—ë—Ä—Ç–∫—É, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
        if (menuEl.parentElement === document.body) {
          wrap.appendChild(menuEl);
        }
        window.removeEventListener('scroll', placeMenu, true);
        window.removeEventListener('resize', placeMenu, true);
      }
      toggleEl.onclick = (e) => {
        e.stopPropagation();
        if (wrap.classList.contains('open')) closeMenu(); else openMenu();
      };
      document.addEventListener('click', (e) => {
        if (!wrap.contains(e.target)) closeMenu();
      });
    }
    function initSoftSelect(selectId, placeholder){
      const sel = document.getElementById(selectId);
      const wrap = document.querySelector(`.soft-select[data-target="${selectId}"]`);
      if (!sel || !wrap) return;
      const toggle = wrap.querySelector('.soft-select-toggle');
      const menu = wrap.querySelector('.soft-select-menu');
      buildSoftSelect(sel, toggle, menu, placeholder);
      // Sync when value changes externally
      sel.addEventListener('change', () => buildSoftSelect(sel, toggle, menu, placeholder));
      // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: –µ—Å–ª–∏ —ç—Ç–æ —Ö–æ—Å—Ç ‚Äî –ø—Ä–æ—Å—Ç–∞–≤–∏–º inbound —Å—Ä–∞–∑—É
      if (selectId === 'host_name') { try { updateInbound(); } catch(_){} }
      // Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { const w = toggle.closest('.soft-select'); if (w?.classList.contains('open')) w.classList.remove('open'); menu.style.display='none'; }});
    }
    function refreshSoftSelect(selectId, placeholder){
      const sel = document.getElementById(selectId);
      const wrap = document.querySelector(`.soft-select[data-target="${selectId}"]`);
      if (!sel || !wrap) return;
      const toggle = wrap.querySelector('.soft-select-toggle');
      const menu = wrap.querySelector('.soft-select-menu');
      buildSoftSelect(sel, toggle, menu, placeholder);
      if (selectId === 'host_name') { try { updateInbound(); } catch(_){} }
    }

    function setExpiryDays(days){
      if (!expiryInput) return;
      const d = new Date();
      d.setDate(d.getDate() + Number(days || 0));
      const pad = n => String(n).padStart(2,'0');
      const val = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      expiryInput.value = val;
      if (window.flatpickr && expiryInput._flatpickr) {
        expiryInput._flatpickr.setDate(val, true, 'Y-m-d H:i');
      }
    }

    function updateInbound() {
      if (!hostSel || !inboundEl) return;
      let opt = hostSel.options[hostSel.selectedIndex];
      if ((!opt || !opt.getAttribute) && hostSel.value) {
        // –ü–æ–∏—â–µ–º option –ø–æ value –≤—Ä—É—á–Ω—É—é
        opt = Array.from(hostSel.options || []).find(o => String(o.value) === String(hostSel.value));
      }
      inboundEl.value = (opt && opt.getAttribute('data-inbound')) ? opt.getAttribute('data-inbound') : '‚Äî';
    }
    async function loadPlansAndRestore() {
      if (!hostSel || !planSel) return;
      const host = hostSel.value;
      if (!host) { planSel.innerHTML = '<option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>'; planSel.disabled = true; return; }
      planSel.disabled = true;
      planSel.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
      try {
        const res = await fetch(`{{ url_for('admin_get_plans_for_host_json', host_name='__HOST__') }}`.replace('__HOST__', encodeURIComponent(host)));
        const d = await res.json();
        const items = (d && d.ok && d.items) ? d.items : [];
        const saved = (JSON.parse(localStorage.getItem('admin_keys_form')||'{}')||{}).plan_select;
        planSel.innerHTML = '<option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>' + items.map(p => `<option value="${p.months}" data-price="${p.price||0}">${p.plan_name} (${p.months} –º–µ—Å.) ‚Äî ${Number(p.price||0).toFixed(0)} RUB</option>`).join('');
        planSel.disabled = false;
        // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (saved) {
          planSel.value = saved;
          const opt = planSel.options[planSel.selectedIndex];
          const price = opt ? Number(opt.getAttribute('data-price')||0) : 0;
          if (priceEl) priceEl.textContent = saved ? `${price.toFixed(0)} RUB` : '‚Äî RUB';
          const months = Number(saved || 0);
          if (months > 0) setExpiryDays(months * 30);
        } else if (priceEl) { priceEl.textContent = '‚Äî RUB'; }
        // –æ–±–Ω–æ–≤–∏–º –º—è–≥–∫–∏–π —Å–µ–ª–µ–∫—Ç–æ—Ä —Ç–∞—Ä–∏—Ñ–∞
        refreshSoftSelect('plan_select', '‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî');
      } catch(_) {
        planSel.innerHTML = '<option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>';
        planSel.disabled = false;
        if (priceEl) priceEl.textContent = '‚Äî RUB';
      }
    }
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    if (hostSel && hostSel.value) {
      try { updateInbound(); } catch(_){}
      loadPlansAndRestore();
    }
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º soft-select-–æ–±—ë—Ä—Ç–∫–∏
    initSoftSelect('host_name', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Å—Ç...');
    initSoftSelect('plan_select', '‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî');

    // ---- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID / @username) ----
    function initUserSuggest(){
      const input = document.getElementById('user_id');
      if (!input) return;
      let menu = document.createElement('div');
      menu.className = 'soft-select-menu';
      menu.style.position = 'fixed';
      menu.style.display = 'none';
      document.body.appendChild(menu);

      function place(){
        const r = input.getBoundingClientRect();
        menu.style.left = `${Math.round(r.left)}px`;
        menu.style.top = `${Math.round(r.bottom + 6)}px`;
        menu.style.width = `${Math.round(r.width)}px`;
        menu.style.zIndex = '1065';
      }
      function close(){ menu.style.display='none'; }
      function open(){ place(); menu.style.display='block'; }

      function render(list){
        menu.innerHTML='';
        list.slice(0, 8).forEach(u => {
          const item = document.createElement('div');
          item.className='soft-select-item';
          const username = u.username ? '@'+String(u.username) : '‚Äî';
          item.innerHTML = `<div style="font-weight:600">${u.telegram_id}</div><div style="opacity:.75">${username}</div>`;
          item.onclick = async ()=>{
            input.value = String(u.telegram_id);
            close();
            try { await normalizeUserId(); await maybeGenEmail(); } catch(_){ }
          };
          menu.appendChild(item);
        });
        if (list.length===0){
          const none=document.createElement('div');
          none.className='soft-select-item';
          none.style.opacity='.7';
          none.textContent='–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
          menu.appendChild(none);
        }
      }

      function applyFilter(){
        const q = String(input.value||'').trim().toLowerCase();
        if (!q){ close(); return; }
        const arr = (USERS||[]).filter(u=>{
          const idm = String(u.telegram_id||'').includes(q);
          const unm = (u.username?('@'+String(u.username).toLowerCase()):'').includes(q);
          return idm || unm;
        });
        render(arr);
        open();
      }

      input.addEventListener('focus', ()=>{ applyFilter(); });
      input.addEventListener('input', ()=>{ applyFilter(); });
      window.addEventListener('scroll', place, true);
      window.addEventListener('resize', place, true);
      document.addEventListener('click', (e)=>{ if (!menu.contains(e.target) && e.target!==input) close(); });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') close(); });
    }
    initUserSuggest();

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è user_id: –µ—Å–ª–∏ –≤–≤–µ–¥—ë–Ω @username ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ telegram_id
    async function normalizeUserId(){
      if (!userInput) return;
      const raw = String(userInput.value||'').trim();
      if (!raw) return;
      if (!/^[0-9]+$/.test(raw)) {
        const key = raw.startsWith('@') ? raw.toLowerCase() : ('@'+raw.toLowerCase());
        if (USER_MAP[key]) {
          userInput.value = String(USER_MAP[key]);
          try { localStorage.setItem('admin_keys_form', JSON.stringify({ ...JSON.parse(localStorage.getItem('admin_keys_form')||'{}'), user_id: userInput.value })); } catch(_){ }
        }
      }
    }

    // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è email
    async function maybeGenEmail(){
      if (!emailInput || !userInput) return;
      const userId = userInput.value && String(userInput.value).trim();
      if (!userId) return;
      try {
        const res = await fetch(`{{ url_for('generate_key_email_route') }}?user_id=${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (data && data.ok && data.email) { emailInput.value = data.email; }
      } catch(_) {}
    }
    if (userInput) {
      userInput.addEventListener('blur', async ()=>{ await normalizeUserId(); await maybeGenEmail(); });
      userInput.addEventListener('change', async ()=>{ await normalizeUserId(); await maybeGenEmail(); });
      // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      (async ()=>{ await normalizeUserId(); await maybeGenEmail(); })();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤/–¥–Ω–µ–π/–ø—Ä–µ—Å–µ—Ç–æ–≤
    if (planSel) {
      planSel.addEventListener('change', () => {
        const months = Number(planSel.value || 0);
        if (months > 0) setExpiryDays(months * 30);
        const opt = planSel.options[planSel.selectedIndex];
        const price = opt ? Number(opt.getAttribute('data-price')||0) : 0;
        if (priceEl) priceEl.textContent = `${price.toFixed(0)} RUB`;
      });
    }
    if (daysInput) {
      daysInput.addEventListener('input', () => {
        const days = Number(daysInput.value || 0);
        if (days > 0) setExpiryDays(days);
      });
    }
    document.querySelectorAll('[data-preset]').forEach(btn => {
      btn.addEventListener('click', () => {
        const add = Number(btn.getAttribute('data-preset')) || 0;
        if (add > 0) setExpiryDays(add);
      });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ inbound –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ö–æ—Å—Ç–∞
    if (hostSel && inboundEl) {
      hostSel.addEventListener('change', () => {
        updateInbound();
        loadPlansAndRestore();
      });
    }

    async function doSubmit(){
      // –û–±–Ω–æ–≤–∏–º email –ø–µ—Ä–µ–¥ —Å–∞–±–º–∏—Ç–æ–º, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await (async ()=>{ try { await maybeGenEmail(); } catch(_){} })();
      submitBtn.disabled = true; submitBtn.textContent = '–°–æ–∑–¥–∞—é...';
      try {
        const fd = new FormData(form);
        const res = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
        const data = await res.json().catch(()=>({ok:false}));
        if (data && data.ok) {
          try { window.showToast('success', '–ö–ª—é—á —Å–æ–∑–¥–∞–Ω'); } catch(_){ }
          // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É –∫–ª—é—á–µ–π –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
          try {
            const tbody = document.querySelector('table.table tbody');
            if (tbody) {
              const uid = String(document.getElementById('user_id')?.value||'');
              const host = String(document.getElementById('host_name')?.value||'');
              const email = String(document.getElementById('key_email')?.value||'');
              const uuid = String(data.uuid || '');
              const expMs = Number(data.expiry_ms||0);
              const dt = expMs ? new Date(expMs) : null;
              const two = n => String(n).padStart(2,'0');
              const expStr = dt ? `${dt.getFullYear()}-${two(dt.getMonth()+1)}-${two(dt.getDate())} ${two(dt.getHours())}:${two(dt.getMinutes())}` : '';
              const now = new Date();
              const createdStr = `${now.getFullYear()}-${two(now.getMonth()+1)}-${two(now.getDate())} ${two(now.getHours())}:${two(now.getMinutes())}`;
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>#${data.key_id||''}</td>
                <td>${uid}</td>
                <td>${host}</td>
                <td>${email}</td>
                <td class="text-truncate" style="max-width:180px">${uuid}</td>
                <td>${expStr}</td>
                <td>${createdStr}</td>
                <td><span class="text-secondary">‚Äî</span></td>
              `;
              tbody.prepend(tr);
            }
          } catch(_){}
          // –¢–∞–∫–∂–µ —Å—Ä–∞–∑—É –ø–æ–¥—Ç—è–Ω–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π partial, —á—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –±—ã–ª–∞ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
          try { await refreshContainerById('keys-tbody'); } catch(_){ }
        } else {
          try { window.showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á'); } catch(_){ }
        }
      } catch (err) {
        try { window.showToast('danger', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–∞'); } catch(_){ }
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á';
      }
    }

    submitBtn.addEventListener('click', doSubmit);
  })();
</script>

<!-- –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ –∫–ª—é—á–∞–º–∏ -->
<div id="expired-toolbar" class="d-flex justify-content-end align-items-center my-2 gap-2">
  <form action="{{ url_for('sweep_expired_keys_route') }}" method="post" data-confirm="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏—Å—Ç—ë–∫—à–∏–µ –∫–ª—é—á–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <button type="submit" class="btn btn-outline-danger btn-sm btn-glass" title="–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ" data-bs-toggle="tooltip">
      <i class="ti ti-broom"></i> –£–¥–∞–ª–∏—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ
    </button>
  </form>
  </div>

<script>
  // –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ø–∞–Ω–µ–ª—å —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç—ë–∫—à–∏—Ö –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π –∫–ª—é—á–µ–π
  (function(){
    const toolbar = document.getElementById('expired-toolbar');
    const tbody = document.getElementById('keys-tbody');
    if (toolbar && tbody) {
      const table = tbody.closest('table');
      if (table && table.parentElement) {
        table.parentElement.insertBefore(toolbar, table);
      }
    }
  })();
</script>

<!-- Modal: –°–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–∞ -->
<div class="modal modal-blur fade" id="expiryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="expiryDelta" class="form-label">–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–∏–±–∞–≤–∏—Ç—å/—É–±–∞–≤–∏—Ç—å</label>
        <input type="number" class="form-control" id="expiryDelta" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 7 –∏–ª–∏ -7" />
        <small class="text-secondary">–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Å—Ä–æ–∫–∞.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="expirySaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–¥–∞–ª–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
  (function(){
    function getCsrf(){
      const m = document.querySelector('meta[name="csrf-token"]');
      return m ? m.getAttribute('content') : '';
    }
    const modalEl = document.getElementById('expiryModal');
    const inputEl = document.getElementById('expiryDelta');
    const saveBtn = document.getElementById('expirySaveBtn');
    let currentKeyId = null;

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-open-expiry');
      if (!btn) return;
      currentKeyId = btn.getAttribute('data-key-id');
      inputEl.value = '';
      try { new bootstrap.Modal(modalEl).show(); } catch(_){ }
    });

    async function doSave(){
      const val = String(inputEl.value||'').trim();
      if (!currentKeyId || !val) { try { window.showToast('warning', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π'); } catch(_){ } return; }
      const delta = Number(val);
      if (!Number.isFinite(delta) || Math.abs(delta) > 3650) { try { window.showToast('warning', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'); } catch(_){ } return; }
      const url = `{{ url_for('adjust_key_expiry_route', key_id=0) }}`.replace('/0/', `/${encodeURIComponent(currentKeyId)}/`);
      const fd = new FormData();
      fd.append('csrf_token', getCsrf());
      fd.append('delta_days', String(delta));
      saveBtn.disabled = true; saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      try{
        const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
        if (resp.ok) {
          // Try to update the expiry cell immediately for better UX
          try {
            const data = await resp.json().catch(()=>null);
            const ms = data && data.new_expiry_ms ? Number(data.new_expiry_ms) : 0;
            if (ms > 0) {
              const dt = new Date(ms);
              const two = n => String(n).padStart(2,'0');
              const expStr = `${dt.getFullYear()}-${two(dt.getMonth()+1)}-${two(dt.getDate())} ${two(dt.getHours())}:${two(dt.getMinutes())}`;
              const btn = document.querySelector(`.btn-open-expiry[data-key-id="${CSS.escape(String(currentKeyId))}"]`);
              if (btn) {
                const tr = btn.closest('tr');
                if (tr) {
                  // expiry cell is the 6th column (0-based index 5)
                  const cell = tr.querySelectorAll('td')[5];
                  if (cell) cell.textContent = expStr;
                }
              }
            }
          } catch(_){ }
          try { bootstrap.Modal.getInstance(modalEl)?.hide(); } catch(_){ }
          try { window.showToast('success', '–°—Ä–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω'); } catch(_){ }
          try { await refreshContainerById('keys-tbody'); } catch(_){ }
        } else {
          let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ä–æ–∫';
          try { const data = await resp.json(); if (data && data.error) msg += `: ${data.error}`; } catch(_){}
          try { window.showToast('danger', msg); } catch(_){ }
        }
      }catch(_){ try { window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } catch(__){} }
      finally { saveBtn.disabled = false; saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }
    }
    if (saveBtn) saveBtn.addEventListener('click', doSave);
  })();
</script>

<!-- Modal: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–ª—é—á—É -->
<div class="modal modal-blur fade" id="commentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–ª—é—á—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="commentInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="commentSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
  </div>

<script>
  (function(){
    const modalEl = document.getElementById('commentModal');
    const inputEl = document.getElementById('commentInput');
    const saveBtn = document.getElementById('commentSaveBtn');
    let currentKeyId = null;

    function getCsrf(){
      const m = document.querySelector('meta[name="csrf-token"]');
      return m ? m.getAttribute('content') : '';
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-edit-comment');
      if (!btn) return;
      currentKeyId = btn.getAttribute('data-key-id');
      const cur = btn.getAttribute('data-current-comment') || '';
      inputEl.value = cur;
      try { new bootstrap.Modal(modalEl).show(); } catch(_){ }
    });

    async function saveComment(){
      if (!currentKeyId) return;
      const url = `{{ url_for('update_key_comment_route', key_id=0) }}`.replace('/0/', `/${encodeURIComponent(currentKeyId)}/`);
      const fd = new FormData();
      fd.append('csrf_token', getCsrf());
      fd.append('comment', inputEl.value || '');
      saveBtn.disabled = true; saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      try {
        const resp = await fetch(url, { method: 'POST', body: fd, credentials: 'same-origin' });
        if (resp.ok) {
          try { bootstrap.Modal.getInstance(modalEl)?.hide(); } catch(_){ }
          try { await refreshContainerById('keys-tbody'); } catch(_){ }
          try { window.showToast('success', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); } catch(_){ }
        } else {
          let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
          try { const data = await resp.json(); if (data && data.error) msg += `: ${data.error}`; } catch(_){}
          try { window.showToast('danger', msg); } catch(_){ }
        }
      } catch (err) {
        try { window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } catch(_){ }
      } finally {
        saveBtn.disabled = false; saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }

    if (saveBtn) saveBtn.addEventListener('click', saveComment);
  })();
</script>

<!-- Flatpickr –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script>
  (function(){
    const el = document.getElementById('expiry_date');
    if (el && window.flatpickr) {
      flatpickr(el, {
        enableTime: true,
        time_24hr: true,
        dateFormat: 'Y-m-d H:i',
        minuteIncrement: 5,
        locale: flatpickr.l10ns.ru || 'ru',
      });
    }
  })();
</script>
{% endblock %}
