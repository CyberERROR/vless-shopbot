{% extends "base.html" %} {% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %} {% block content %}

<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <div class="text-secondary">–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
    </div>
    <div class="col-auto ms-auto d-print-none">
      <div class="d-flex">
        <input id="users-search" type="text" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ Username..."
          value="{{ q or '' }}" />
      </div>
    </div>
  </div>
</div>


<div class="modal modal-blur fade" id="balanceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 text-secondary" id="bm-user"></div>
        <div class="mb-2">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong id="bm-balance">0.00</strong> RUB</div>
        <form id="bm-form" class="d-flex gap-2" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input class="form-control" type="text" inputmode="decimal" name="delta" placeholder="¬± —Å—É–º–º–∞" required />
          <button class="btn btn-primary" type="submit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </form>
        <hr />
        <div class="mb-1">–†–µ—Ñ–µ—Ä–∞–ª—ã: <strong id="bm-refcount">0</strong></div>
        <div class="small text-secondary" style="max-height:180px;overflow:auto;">
          <ul class="list-unstyled mb-0" id="bm-reflist"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="messageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 text-secondary" id="mm-user"></div>
        <form id="mm-form" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="mb-3">
            <label class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <i class="mb-2 text-secondary">üì© –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</i>
            <textarea class="form-control" name="message" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."
              required></textarea>
          </div>
          <button class="btn btn-primary w-100" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="udm-loading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          </div>
        </div>
        <div id="udm-content" style="display:none;">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><strong>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</strong></div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tbody>
                      <tr>
                        <td><strong>Telegram ID:</strong></td>
                        <td id="udm-telegram-id"></td>
                      </tr>
                      <tr>
                        <td><strong>Username:</strong></td>
                        <td id="udm-username"></td>
                      </tr>
                      <tr>
                        <td><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong></td>
                        <td id="udm-registration"></td>
                      </tr>
                      <tr>
                        <td><strong>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ:</strong></td>
                        <td id="udm-total-spent"></td>
                      </tr>
                      <tr>
                        <td><strong>–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ –º–µ—Å—è—Ü–µ–≤:</strong></td>
                        <td id="udm-total-months"></td>
                      </tr>
                      <tr>
                        <td><strong>–ü—Ä–æ–±–Ω—ã–π:</strong></td>
                        <td>
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="udm-trial-toggle" data-user-id="">
                            <label class="form-check-label" for="udm-trial-toggle" id="udm-trial-label"></label>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header"><strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</strong></div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tbody>
                      <tr>
                        <td><strong>–†–µ—Ñ. –∫–æ–¥:</strong></td>
                        <td id="udm-ref-code"></td>
                      </tr>
                      <tr>
                        <td><strong>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</strong></td>
                        <td id="udm-ref-count"></td>
                      </tr>
                      <tr>
                        <td><strong>–ü—Ä–∏–≥–ª–∞—à—ë–Ω:</strong></td>
                        <td id="udm-referred-by"></td>
                      </tr>
                      <tr>
                        <td><strong>–ë–∞–ª–∞–Ω—Å:</strong></td>
                        <td id="udm-balance"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Subscriptions Block -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <strong>–ü–æ–¥–ø–∏—Å–∫–∏</strong> <span id="udm-subs-stats" class="ms-2 text-muted small"></span>
                </div>
                <div class="card-body p-0">
                  <div id="udm-subs-list" style="max-height: 300px; overflow-y: auto;"
                    class="list-group list-group-flush">
                    <!-- Subscriptions will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header"><strong>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</strong></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>–î–∞—Ç–∞</th>
                          <th>–¢–∞—Ä–∏—Ñ</th>
                          <th>–°—É–º–º–∞</th>
                        </tr>
                      </thead>
                      <tbody id="udm-payment-history">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header"><strong>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–ª–∞–Ω—Å–∞</strong></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>–î–∞—Ç–∞</th>
                          <th>–¢–∏–ø</th>
                          <th>–°—É–º–º–∞</th>
                        </tr>
                      </thead>
                      <tbody id="udm-balance-history">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card card-compact glass">
  <div class="card-body">
    <div class="table-responsive">
      <table id="users-table" class="table table-vcenter table-compact">
        <thead>
          <tr>
            <th>Telegram ID</th>
            <th>Username</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏</th>
            <th>–ë–∞–ª–∞–Ω—Å</th>
            <th style="width: 140px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="users-tbody"
          data-fetch-url="{{ url_for('users_table_partial', page=current_page, per_page=per_page, q=q) }}"
          data-fetch-interval="1000000">
          {% for user in users %}
          <tr>
            <td class="user-id">{{ user.telegram_id }}</td>
            <td class="user-name">@{{ user.username or 'N/A' }}</td>
            <td>
              {% if user.is_banned %}
              <span class="badge bg-red">–ó–∞–±–∞–Ω–µ–Ω</span>
              {% else %}
              <span class="badge bg-green">–ê–∫—Ç–∏–≤–µ–Ω</span>
              {% endif %}
            </td>
            <td>{{ user.keys_count or 0 }} —à—Ç.</td>
            <td>{{ '%.2f'|format(user.balance or 0) }}</td>
            <td>
              <div class="btn-list">
                <a class="btn btn-primary btn-xs btn-glass"
                  href="{{ url_for('admin_keys_page') }}?user_id={{ user.telegram_id }}" title="–í—ã–¥–∞—Ç—å –∫–ª—é—á"
                  aria-label="–í—ã–¥–∞—Ç—å –∫–ª—é—á">
                  <i class="ti ti-key"></i>
                </a>
                <button type="button" class="btn btn-success btn-xs btn-glass btn-user-balance-sign"
                  data-uid="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}"
                  data-balance="{{ '%.2f'|format(user.balance or 0) }}" data-sign="+" title="–ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å"
                  aria-label="–ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å">
                  <i class="ti ti-plus"></i>
                </button>
                <button type="button" class="btn btn-danger btn-xs btn-glass btn-user-balance-sign"
                  data-uid="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}"
                  data-balance="{{ '%.2f'|format(user.balance or 0) }}" data-sign="-" title="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å"
                  aria-label="–°–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å">
                  <i class="ti ti-minus"></i>
                </button>
                <button type="button" class="btn btn-info btn-xs btn-glass btn-user-message"
                  data-uid="{{ user.telegram_id }}" data-username="{{ user.username or 'N/A' }}"
                  title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                  <i class="ti ti-message"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs btn-glass" data-toggle="keys"
                  data-user="{{ user.telegram_id }}" title="–ö–ª—é—á–∏" aria-label="–ö–ª—é—á–∏">
                  <i class="ti ti-key"></i>
                </button>
                {% if user.is_banned %}
                <form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="submit" class="btn btn-success btn-xs btn-glass" title="–†–∞–∑–±–∞–Ω–∏—Ç—å"
                    aria-label="–†–∞–∑–±–∞–Ω–∏—Ç—å"><i class="ti ti-circle-check"></i></button>
                </form>
                {% else %}
                <form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post"
                  data-confirm="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –û–Ω –Ω–µ —Å–º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º.">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="submit" class="btn btn-warning btn-xs btn-glass" title="–ë–∞–Ω" aria-label="–ë–∞–Ω"><i
                      class="ti ti-ban"></i></button>
                </form>
                {% endif %}
                {% if (user.keys_count or 0) > 0 %}
                <form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post"
                  data-confirm="–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–æ–≤. –í—ã —É–≤–µ—Ä–µ–Ω—ã?"
                  data-ajax="delete" data-refresh-target="users-tbody" data-action="revoke-keys">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="submit" class="btn btn-danger btn-xs btn-glass" title="–û—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á–∏"
                    aria-label="–û—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á–∏"><i class="ti ti-trash-x"></i></button>
                </form>
                {% endif %}
                <br>
                <button type="button" class="btn btn-secondary btn-xs btn-glass btn-user-details"
                  data-uid="{{ user.telegram_id }}" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ" aria-label="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                  <i class="ti ti-info-circle">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</i>
                </button>
              </div>
            </td>
          </tr>
          <tr class="keys-row" id="keys-{{ user.telegram_id }}" style="display:none;"
            data-src="{{ url_for('user_keys_partial', user_id=user.telegram_id) }}">
            <td colspan="6">
              <div class="card card-compact">
                <div class="card-header"><strong>–ö–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong></div>
                <div class="card-body p-2" data-lazy="keys"></div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if total_pages and total_pages > 1 %}
<div class="d-flex justify-content-center mt-3">
  <ul id="users-pagination" class="pagination"
    data-src="{{ url_for('users_pagination_partial', page=current_page, q=q, per_page=per_page) }}">
    {% include 'partials/users_pagination.html' %}
  </ul>
</div>
{% endif %}

<script>
  (function () {
    const input = document.getElementById('users-search');
    const table = document.getElementById('users-table');
    if (!input || !table) return;
    function norm(s) { return (s || '').toString().toLowerCase().trim(); }
    // –•—Ä–∞–Ω–∏–º —Ä–∞—Å–∫—Ä—ã—Ç—ã–µ –∫–ª—é—á–∏ –º–µ–∂–¥—É –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
    const LS_KEY = 'users_open_keys_ids';
    function loadOpenSet() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      } catch (_) { return new Set(); }
    }
    function saveOpenSet(set) {
      try { localStorage.setItem(LS_KEY, JSON.stringify(Array.from(set))); } catch (_) { }
    }
    const openSet = loadOpenSet();
    function getMainTbody() {
      // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω—ã–π tbody —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)
      return table.tBodies && table.tBodies.length ? table.tBodies[0] : table.querySelector('tbody');
    }
    function getRows() {
      // –¢–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ –¥–æ—á–µ—Ä–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ tbody, –∏—Å–∫–ª—é—á–∞—è keys-row
      const tbody = getMainTbody();
      if (!tbody) return [];
      return Array.from(tbody.children).filter(tr => tr.tagName === 'TR' && !tr.classList.contains('keys-row'));
    }
    function getKeysRowByUid(uid) { return document.getElementById('keys-' + uid); }
    async function ensureKeysLoaded(uid) {
      const row = getKeysRowByUid(uid);
      if (!row) return;
      const body = row.querySelector('[data-lazy="keys"]');
      if (!body) return;
      if (body.getAttribute('data-loaded') === '1') return;
      const src = row.getAttribute('data-src');
      if (!src) return;
      try {
        const resp = await fetch(src, { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
        if (!resp.ok) return;
        const html = await resp.text();
        body.innerHTML = html;
        body.setAttribute('data-loaded', '1');
      } catch (_) { }
    }
    function openKeysForUid(uid) {
      const row = getKeysRowByUid(uid);
      if (!row) return;
      row.style.display = '';
      openSet.add(String(uid));
      saveOpenSet(openSet);
      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞/—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      const btn = table.querySelector(`[data-toggle="keys"][data-user="${uid}"]`);
      if (btn) {
        btn.classList.add('btn-secondary');
        btn.classList.remove('btn-outline-secondary');
      }
    }
    function closeKeysForUid(uid) {
      const row = getKeysRowByUid(uid);
      if (!row) return;
      row.style.display = 'none';
      openSet.delete(String(uid));
      saveOpenSet(openSet);
      const btn = table.querySelector(`[data-toggle="keys"][data-user="${uid}"]`);
      if (btn) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-outline-secondary');
      }
    }
    function restoreOpenedKeys() {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ tbody
      openSet.forEach(uid => {
        const row = getKeysRowByUid(uid);
        if (row) {
          row.style.display = '';
          const btn = table.querySelector(`[data-toggle="keys"][data-user="${uid}"]`);
          if (btn) {
            btn.classList.add('btn-secondary');
            btn.classList.remove('btn-outline-secondary');
          }
        }
      });
    }
    function applyFilter() {
      const q = norm(input.value);
      const rows = getRows();
      rows.forEach(tr => {
        const id = norm(tr.querySelector('.user-id')?.textContent);
        const name = norm(tr.querySelector('.user-name')?.textContent);
        const ok = !q || id.includes(q) || name.includes(q);
        tr.style.display = ok ? '' : 'none';
      });
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∫ –∫–ª—é—á–µ–π —Å –≤–∏–¥–∏–º–æ—Å—Ç—å—é —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º keys-row —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∏–º–∞ –∏ –æ–Ω —á–∏—Å–ª–∏—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º –≤ openSet
      const tbody = getMainTbody();
      const allKeysRows = tbody ? Array.from(tbody.querySelectorAll(':scope > tr.keys-row')) : [];
      allKeysRows.forEach(kr => {
        const uid = (kr.id || '').replace('keys-', '');
        const userRow = getRows().find(r => r.querySelector('.user-id')?.textContent?.trim() === uid);
        const userVisible = userRow && userRow.style.display !== 'none';
        const shouldShow = userVisible && openSet.has(String(uid));
        kr.style.display = shouldShow ? '' : 'none';
        const btn = table.querySelector(`[data-toggle="keys"][data-user="${uid}"]`);
        if (btn) {
          btn.classList.toggle('btn-secondary', shouldShow);
          btn.classList.toggle('btn-outline-secondary', !shouldShow);
        }
      });
    }
    input.addEventListener('input', applyFilter);
    input.addEventListener('keyup', applyFilter);
    input.addEventListener('search', applyFilter); // –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —á–µ—Ä–µ–∑ –∫—Ä–µ—Å—Ç–∏–∫
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ –ø–∞—É–∑–µ –≤–≤–æ–¥–∞ (debounce)
    (function () {
      let t = null; const DEBOUNCE = 400; const tbody = document.getElementById('users-tbody');
      async function pushQuery() {
        const q = encodeURIComponent(input.value || '');
        const url = new URL(tbody.getAttribute('data-fetch-url'), window.location.origin);
        url.searchParams.set('q', input.value || '');
        url.searchParams.set('page', '1');
        try {
          const resp = await fetch(url.toString(), { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
          const html = await resp.text();
          if (html) { tbody.innerHTML = html; restoreOpenedKeys(); applyFilter(); }
          // –í–∞–∂–Ω–æ: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º data-fetch-url —Å —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º,
          // —á—Ç–æ–±—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          tbody.setAttribute('data-fetch-url', url.pathname + '?' + url.searchParams.toString());
          // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
          const pag = document.getElementById('users-pagination');
          if (pag) {
            const purl = new URL(pag.getAttribute('data-src'), window.location.origin);
            purl.searchParams.set('q', input.value || ''); purl.searchParams.set('page', '1');
            const presp = await fetch(purl.toString(), { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
            const phtml = await presp.text(); if (phtml) pag.innerHTML = phtml;
          }
          // –û–±–Ω–æ–≤–∏–º –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É
          try {
            history.replaceState(null, '', '/users?page=1' + (input.value ? ('&q=' + encodeURIComponent(input.value)) : ''));
          } catch (_) { }
        } catch (_) { }
      }
      input.addEventListener('input', () => { clearTimeout(t); t = setTimeout(pushQuery, DEBOUNCE); });
    })();
    // –ü—Ä–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ tbody ‚Äî —Å–Ω–æ–≤–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
    (function () {
      const tbody = document.getElementById('users-tbody');
      if (!tbody) return;
      let t = null;
      const obs = new MutationObserver(() => {
        clearTimeout(t);
        t = setTimeout(() => { applyFilter(); restoreOpenedKeys(); }, 50);
      });
      obs.observe(tbody, { childList: true, subtree: true });
    })();
    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (partial)
    (function () {
      const tbody = document.getElementById('users-tbody');
      const pag = document.getElementById('users-pagination');
      if (!tbody || !pag) return;
      pag.addEventListener('click', async function (e) {
        const a = e.target.closest('a.page-link');
        if (!a) return;
        e.preventDefault();
        const url = new URL(a.getAttribute('href'), window.location.origin);
        try {
          // table
          const turl = new URL(tbody.getAttribute('data-fetch-url'), window.location.origin);
          turl.searchParams.set('page', url.searchParams.get('page') || '1');
          const qVal = url.searchParams.get('q') || (document.getElementById('users-search')?.value || '');
          turl.searchParams.set('q', qVal);
          const resp = await fetch(turl.toString(), { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
          const html = await resp.text();
          if (html) { tbody.innerHTML = html; restoreOpenedKeys(); applyFilter(); }
          // pagination
          const purl = new URL(pag.getAttribute('data-src'), window.location.origin);
          purl.searchParams.set('page', turl.searchParams.get('page'));
          purl.searchParams.set('q', turl.searchParams.get('q'));
          const presp = await fetch(purl.toString(), { headers: { 'Accept': 'text/html' }, credentials: 'same-origin' });
          const phtml = await presp.text();
          if (phtml) pag.innerHTML = phtml;
          // sync data-fetch-url for auto-refresh
          tbody.setAttribute('data-fetch-url', turl.pathname + '?' + turl.searchParams.toString());
          // update URL bar (optional)
          try {
            const qp = turl.searchParams.get('q');
            const pg = turl.searchParams.get('page') || '1';
            history.replaceState(null, '', '/users?page=' + encodeURIComponent(pg) + (qp ? ('&q=' + encodeURIComponent(qp)) : ''));
          } catch (_) { }
        } catch (_) { }
      });
    })();
    // –¢–æ–≥–≥–ª —Å—Ç—Ä–æ–∫–∏ —Å –∫–ª—é—á–∞–º–∏
    table.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-toggle="keys"]');
      if (!btn) return;
      const uid = btn.getAttribute('data-user');
      const row = document.getElementById('keys-' + uid);
      if (!row) return;
      const isHidden = window.getComputedStyle(row).display === 'none';
      if (isHidden) {
        openKeysForUid(uid);
        ensureKeysLoaded(uid);
      } else {
        closeKeysForUid(uid);
      }
    });

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –±–∞–ª–∞–Ω—Å–∞ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∑–Ω–∞–∫–æ–º (+/-)
    table.addEventListener('click', async function (e) {
      const btn = e.target.closest('.btn-user-balance-sign');
      if (!btn) return;
      const uid = btn.getAttribute('data-uid');
      const uname = btn.getAttribute('data-username') || 'N/A';
      const balance = btn.getAttribute('data-balance') || '0.00';
      const sign = btn.getAttribute('data-sign') || '';
      let refs = [];
      try {
        const resp = await fetch(`{{ url_for('user_referrals_json', user_id=0) }}`.replace('/0/', `/${uid}/`), { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
        const data = await resp.json();
        refs = (data && data.ok) ? (data.items || []) : [];
      } catch (_) { refs = []; }

      const modalEl = document.getElementById('balanceModal');
      const bmUser = modalEl.querySelector('#bm-user');
      const bmBal = modalEl.querySelector('#bm-balance');
      const bmForm = modalEl.querySelector('#bm-form');
      const bmCount = modalEl.querySelector('#bm-refcount');
      const bmList = modalEl.querySelector('#bm-reflist');
      const deltaInput = bmForm.querySelector('input[name="delta"]');

      bmUser.textContent = `@${uname} (#${uid})`;
      bmBal.textContent = balance;
      bmForm.action = `{{ url_for('adjust_balance_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
      bmCount.textContent = refs.length;
      bmList.innerHTML = refs.map(r => `<li>#${r.telegram_id} ‚Äî @${(r.username || 'N/A')} ¬∑ ${r.registration_date}</li>`).join('');

      // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞–∫ –∏ —Å—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
      try {
        deltaInput.value = sign;
        deltaInput.focus();
        const len = deltaInput.value.length;
        deltaInput.setSelectionRange(len, len);
      } catch (_) { }

      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    });

    // AJAX-—Å–∞–±–º–∏—Ç —Ñ–æ—Ä–º—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É)
    (function () {
      const modalEl = document.getElementById('balanceModal');
      if (!modalEl) return;
      const form = modalEl.querySelector('#bm-form');
      if (!form) return;
      form.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        try {
          const fd = new FormData(form);
          // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º csrf
          if (!fd.get('csrf_token')) {
            const meta = document.querySelector('meta[name="csrf-token"]');
            const token = meta ? meta.getAttribute('content') : '';
            if (token) fd.append('csrf_token', token);
          }
          const resp = await fetch(form.action, {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
          });
          const data = await resp.json().catch(() => null);
          if (resp.ok && data && data.ok) {
            try { window.showToast('success', data.message || '–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—ë–Ω.'); } catch (_) { }
            try { bootstrap.Modal.getInstance(modalEl)?.hide(); } catch (_) { }
            try { await window.refreshContainerById('users-tbody'); } catch (_) { }
          } else {
            const msg = (data && data.message) || (data && data.error) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å';
            try { window.showToast('danger', msg); } catch (_) { }
          }
        } catch (_) {
          try { window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } catch (__) { }
        }
      });
    })();

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    table.addEventListener('click', function (e) {
      const btn = e.target.closest('.btn-user-message');
      if (!btn) return;
      const uid = btn.getAttribute('data-uid');
      const uname = btn.getAttribute('data-username') || 'N/A';

      const modalEl = document.getElementById('messageModal');
      const mmUser = modalEl.querySelector('#mm-user');
      const mmForm = modalEl.querySelector('#mm-form');
      const messageInput = mmForm.querySelector('textarea[name="message"]');

      mmUser.textContent = `@${uname} (#${uid})`;
      mmForm.action = `{{ url_for('send_user_message_route', user_id=0) }}`.replace('/0/', `/${uid}/`);
      messageInput.value = '';

      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setTimeout(() => messageInput.focus(), 300);
    });

    // AJAX-—Å–∞–±–º–∏—Ç —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    (function () {
      const modalEl = document.getElementById('messageModal');
      if (!modalEl) return;
      const form = modalEl.querySelector('#mm-form');
      if (!form) return;
      form.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        try {
          const fd = new FormData(form);
          // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º csrf
          if (!fd.get('csrf_token')) {
            const meta = document.querySelector('meta[name="csrf-token"]');
            const token = meta ? meta.getAttribute('content') : '';
            if (token) fd.append('csrf_token', token);
          }
          const resp = await fetch(form.action, {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
          });
          const data = await resp.json().catch(() => null);
          if (resp.ok && data && data.ok) {
            try { window.showToast('success', data.message || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.'); } catch (_) { }
            try { bootstrap.Modal.getInstance(modalEl)?.hide(); } catch (_) { }
          } else {
            const msg = (data && data.message) || (data && data.error) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
            try { window.showToast('danger', msg); } catch (_) { }
          }
        } catch (_) {
          try { window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } catch (__) { }
        }
      });
    })();

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    table.addEventListener('click', async function (e) {
      const btn = e.target.closest('.btn-user-details');
      if (!btn) return;
      const uid = btn.getAttribute('data-uid');

      const modalEl = document.getElementById('userDetailsModal');
      const loadingEl = modalEl.querySelector('#udm-loading');
      const contentEl = modalEl.querySelector('#udm-content');

      // Show loading state
      loadingEl.style.display = '';
      contentEl.style.display = 'none';

      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      try {
        const resp = await fetch(`{{ url_for('user_details_json', user_id=0) }}`.replace('/0/', `/${uid}/`), {
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });
        const data = await resp.json();

        if (data && data.ok) {
          // Populate basic info
          modalEl.querySelector('#udm-telegram-id').textContent = data.user.telegram_id || 'N/A';
          modalEl.querySelector('#udm-username').textContent = '@' + (data.user.username || 'N/A');
          modalEl.querySelector('#udm-registration').textContent = data.user.registration_date || 'N/A';
          modalEl.querySelector('#udm-total-spent').textContent = (data.user.total_spent || 0).toFixed(2) + ' RUB';
          modalEl.querySelector('#udm-total-months').textContent = (data.user.total_months || 0) + ' –º–µ—Å.';

          // Trial toggle
          const trialToggle = modalEl.querySelector('#udm-trial-toggle');
          const trialLabel = modalEl.querySelector('#udm-trial-label');
          trialToggle.checked = data.user.trial_used || false;
          trialToggle.setAttribute('data-user-id', uid);
          trialLabel.textContent = data.user.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';

          // Populate referral info
          modalEl.querySelector('#udm-ref-code').textContent = data.user.referral_code || 'N/A';
          modalEl.querySelector('#udm-ref-count').textContent = data.user.referral_count || '0';
          if (data.user.referred_by && data.user.referred_by.username) {
            modalEl.querySelector('#udm-referred-by').textContent = '@' + data.user.referred_by.username + ' (#' + data.user.referred_by.telegram_id + ')';
          } else {
            modalEl.querySelector('#udm-referred-by').textContent = '–ù–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω';
          }
          modalEl.querySelector('#udm-balance').textContent = (data.user.balance || 0).toFixed(2) + ' RUB';

          // Populate subscriptions
          const subsStatsEl = modalEl.querySelector('#udm-subs-stats');
          const subsListEl = modalEl.querySelector('#udm-subs-list');

          if (data.subs_stats) {
            subsStatsEl.textContent = `(–í—Å–µ–≥–æ: ${data.subs_stats.total}, –ê–∫—Ç–∏–≤–Ω–æ: ${data.subs_stats.active}, –ò—Å—Ç–µ–∫–ª–æ: ${data.subs_stats.expired})`;
          } else {
            subsStatsEl.textContent = '';
          }

          subsListEl.innerHTML = '';
          if (data.subscriptions && data.subscriptions.length > 0) {
            data.subscriptions.forEach(sub => {
              const item = document.createElement('div');
              item.className = 'list-group-item';

              const statusClass = sub.is_expired ? 'text-danger' : 'text-success';

              item.innerHTML = `
                <div class="mb-1 small">
                  <span class="${statusClass} fw-bold">${sub.status_text}</span> | –ò—Å—Ç–µ–∫–∞–µ—Ç: ${sub.expire_date}
                </div>
                <div class="text-break font-monospace small bg-light p-1 rounded" style="background-color: #2e3137 !important; margin: 10px 0px !important; padding: 10px 10px !important;">
                  <strong style="font-size: 15px; color: #00ff00;">${sub.key}</strong> 
                </div>
              `;
              subsListEl.appendChild(item);
            });
          } else {
            subsListEl.innerHTML = '<div class="list-group-item text-center text-muted">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</div>';
          }

          // Populate payment history
          const paymentHistoryEl = modalEl.querySelector('#udm-payment-history');
          paymentHistoryEl.innerHTML = '';
          if (data.payment_history && data.payment_history.length > 0) {
            data.payment_history.forEach(payment => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${payment.date || 'N/A'}</td>
                <td>${payment.plan || 'N/A'}</td>
                <td>${(payment.amount || 0).toFixed(2)} RUB</td>
              `;
              paymentHistoryEl.appendChild(row);
            });
          } else {
            paymentHistoryEl.innerHTML = '<tr><td colspan="3" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
          }

          // Populate balance history
          const balanceHistoryEl = modalEl.querySelector('#udm-balance-history');
          balanceHistoryEl.innerHTML = '';
          if (data.balance_history && data.balance_history.length > 0) {
            data.balance_history.forEach(transaction => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${transaction.date || 'N/A'}</td>
                <td>${transaction.type || 'N/A'}</td>
                <td>${(transaction.amount || 0).toFixed(2)} RUB</td>
              `;
              balanceHistoryEl.appendChild(row);
            });
          } else {
            balanceHistoryEl.innerHTML = '<tr><td colspan="3" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
          }

          // Show content
          loadingEl.style.display = 'none';
          contentEl.style.display = '';
        } else {
          try { window.showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); } catch (_) { }
          modal.hide();
        }
      } catch (err) {
        try { window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } catch (_) { }
        modal.hide();
      }
    });

    // Trial toggle handler
    document.addEventListener('change', async function (e) {
      if (e.target && e.target.id === 'udm-trial-toggle') {
        const toggle = e.target;
        const userId = toggle.getAttribute('data-user-id');
        const label = document.getElementById('udm-trial-label');

        try {
          const meta = document.querySelector('meta[name="csrf-token"]');
          const token = meta ? meta.getAttribute('content') : '';

          const resp = await fetch(`{{ url_for('toggle_trial_used_route', user_id=0) }}`.replace('/0/', `/${userId}/`), {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': token
            },
            credentials: 'same-origin'
          });

          const data = await resp.json();

          if (data && data.ok) {
            label.textContent = data.trial_used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ' : '–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ';
            try { window.showToast('success', data.message); } catch (_) { }
          } else {
            // Revert toggle on error
            toggle.checked = !toggle.checked;
            try { window.showToast('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å'); } catch (_) { }
          }
        } catch (err) {
          // Revert toggle on error
          toggle.checked = !toggle.checked;
          try { window.showToast('danger', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } catch (_) { }
        }
      }
    });
  })();
</script>

{% endblock %}